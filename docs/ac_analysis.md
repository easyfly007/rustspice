# AC Analysis in MySpice

## Overview

AC analysis computes the small-signal frequency response of a circuit. It linearizes nonlinear devices around their DC operating point and solves for complex node voltages at each frequency point.

## How AC Analysis Works

### Algorithm Steps

1. **DC Operating Point**: First, a DC analysis is performed to find the operating point. This is needed to linearize nonlinear devices (diodes, MOSFETs).

2. **Linearization**: At the DC operating point, small-signal parameters are extracted:
   - Diodes: Conductance gd = (Is/Vt) * exp(Vd/Vt)
   - MOSFETs: Transconductance gm, output conductance gds, body effect gmbs

3. **Complex MNA Matrix**: For each frequency f:
   - Angular frequency ω = 2πf
   - Build complex admittance matrix Y(jω)
   - Solve Y·V = I for complex node voltages V

4. **Result Storage**: Convert complex voltages to:
   - Magnitude in dB: 20·log₁₀(|V|)
   - Phase in degrees: arg(V)·180/π

### Device Models in AC Analysis

| Device | AC Stamp |
|--------|----------|
| Resistor | Y = G = 1/R (real, frequency-independent) |
| Capacitor | Y = jωC (purely imaginary) |
| Inductor | Y = 1/(jωL) (uses auxiliary variable) |
| Voltage Source | Same as DC + AC excitation phasor |
| Current Source | AC excitation on RHS |
| Diode | Linearized gd at DC operating point |
| MOSFET | Linearized gm, gds, gmbs at DC operating point |
| VCVS/VCCS | Same as DC but with complex types |
| CCCS/CCVS | Same as DC but with complex types |

## Netlist Syntax

### AC Analysis Command

```spice
.AC <sweep_type> <points> <fstart> <fstop>
```

**Parameters:**
- `sweep_type`: Type of frequency sweep
  - `DEC`: Logarithmic, N points per decade
  - `OCT`: Logarithmic, N points per octave
  - `LIN`: Linear, N total points
- `points`: Number of frequency points
- `fstart`: Starting frequency in Hz
- `fstop`: Stopping frequency in Hz

**Examples:**
```spice
.AC DEC 10 1 1MEG      * 10 points per decade from 1 Hz to 1 MHz
.AC OCT 5 100 10K      * 5 points per octave from 100 Hz to 10 kHz
.AC LIN 100 1K 10K     * 100 points linearly from 1 kHz to 10 kHz
```

### AC Source Specification

Voltage and current sources can have AC magnitude and phase:

```spice
V1 in 0 DC 0 AC 1 45    * 1V magnitude, 45 degree phase
I1 out 0 DC 0 AC 1m 0   * 1mA magnitude, 0 degree phase
```

**Format:** `<source> <n+> <n-> DC <dcvalue> AC <magnitude> [phase]`

- `magnitude`: AC amplitude (required for AC analysis)
- `phase`: Phase in degrees (optional, defaults to 0)

## CLI Usage

### Command Line Options

```bash
sim-cli <netlist> -a ac [options]
```

**AC-specific options:**
- `--ac-sweep <TYPE>`: Sweep type: dec, oct, lin (default: dec)
- `--ac-points <N>`: Points per decade/octave or total (default: 10)
- `--ac-fstart <FREQ>`: Start frequency in Hz (default: 1)
- `--ac-fstop <FREQ>`: Stop frequency in Hz (default: 1e6)

**Examples:**
```bash
# Use .ac command from netlist
sim-cli circuit.cir -o output.psf

# Override with CLI options
sim-cli circuit.cir -a ac --ac-sweep dec --ac-points 20 \
    --ac-fstart 1 --ac-fstop 1meg -o output.psf
```

## Example: RC Lowpass Filter

### Circuit
```
     R1 (1k)
in ----/\/\/\---- out
                   |
                  === C1 (1µF)
                   |
                  GND
```

### Netlist
```spice
* RC Lowpass Filter
* Cutoff frequency: fc = 1/(2π·R·C) = 159.15 Hz

V1 in 0 DC 0 AC 1 0
R1 in out 1k
C1 out 0 1u

.ac dec 10 1 1meg
.end
```

### Expected Response

- **Low frequency (f << fc)**: ~0 dB gain, ~0° phase
- **Cutoff frequency (fc = 159 Hz)**: -3 dB gain, -45° phase
- **High frequency (f >> fc)**: -20 dB/decade rolloff, -90° phase

### Running the Analysis

```bash
sim-cli rc_filter.cir -o ac_result.psf
```

### Output Format (PSF)

```
PSF_TEXT
# Generated by MySpice

[AC Analysis]
type = frequency_response
points = 61

[Signals]
frequency
VM(in)
VP(in)
VM(out)
VP(out)

[Data]
      frequency        VM(in)        VP(in)       VM(out)       VP(out)
     1.000000e0      0.000000e0   0.000000e0   0.000000e0  -5.729578e-2
     ...
```

## Transfer Function Analysis

To compute a transfer function H(jω) = Vout/Vin:

1. Set the input source to AC 1 (unity magnitude)
2. Run AC analysis
3. H(jω) in dB = VM(out) - VM(in)
4. Phase of H(jω) = VP(out) - VP(in)

## Limitations

- Only small-signal analysis (linearized around DC operating point)
- No noise analysis currently implemented
- No distortion analysis
- Single-frequency analysis only (no intermodulation)

## Algorithm Background

### Complex Admittance Matrix

The MNA (Modified Nodal Analysis) equations are extended to complex numbers:

**Y(jω) · V = I**

Where:
- Y(jω) is the complex admittance matrix
- V is the vector of complex node voltages
- I is the complex current excitation vector

### Frequency Sweep Types

**Decade (DEC):**
- Frequencies are logarithmically spaced
- N points between 10^k and 10^(k+1)
- Good for Bode plots

**Octave (OCT):**
- Frequencies are logarithmically spaced
- N points between 2^k and 2^(k+1)
- Common in audio applications

**Linear (LIN):**
- Frequencies are linearly spaced
- N total points from fstart to fstop
- Good for narrowband analysis
