# TRAN Waveform Storage Implementation

**Status: ✅ COMPLETED (2026-01-29)**

## Overview

This document describes the implementation of time-series waveform storage for transient (TRAN) analysis in RustSpice. The implementation enables storing voltage values at each accepted time step during simulation, allowing for waveform visualization and analysis.

## Implementation Summary

### What Was Implemented

1. **Data Structure Changes** (`result_store.rs`)
   - Added `tran_times: Vec<f64>` - stores time points at each accepted step
   - Added `tran_solutions: Vec<Vec<f64>>` - stores solution vectors at each time point

2. **Engine Changes** (`engine.rs`)
   - New function `run_tran_result_with_params()` that accepts TRAN parameters (tstep, tstop, tstart, tmax)
   - DC operating point computation at t=0 before time stepping
   - Waveform collection at each accepted time step
   - Proper initialization of transient state from DC solution

3. **PSF Output** (`psf.rs`)
   - `write_psf_tran()` function for waveform export
   - Columnar format with time as first column
   - Support for configurable precision

## Technical Details

### Run Flow

```
1. Parse netlist and build circuit
2. Create Engine with circuit
3. Call run_with_store() with AnalysisPlan
4. For TRAN:
   a. Compute initial DC operating point (t=0)
   b. Store initial time and solution
   c. Time stepping loop:
      - Newton iteration for each time step
      - If converged and error acceptable:
        - Accept step, store time and solution
        - Increase time step (adaptive)
      - Else: reduce time step and retry
5. Return RunResult with tran_times and tran_solutions
```

### Key Code Sections

#### result_store.rs
```rust
pub struct RunResult {
    // ... existing fields ...

    /// TRAN analysis: time points
    pub tran_times: Vec<f64>,
    /// TRAN analysis: solution vectors at each time point
    pub tran_solutions: Vec<Vec<f64>>,
}
```

#### engine.rs
```rust
fn run_tran_result_with_params(
    &mut self,
    tstep: f64,
    tstop: f64,
    tstart: f64,
    tmax: f64,
) -> RunResult {
    // ... setup ...

    // Waveform storage vectors
    let mut tran_times: Vec<f64> = Vec::new();
    let mut tran_solutions: Vec<Vec<f64>> = Vec::new();

    // Run initial DC operating point
    // ...

    // Store initial point (t=tstart)
    tran_times.push(config.tstart);
    tran_solutions.push(x.clone());

    // Time stepping loop
    while step_state.time < config.tstop {
        // ... Newton iteration ...

        if accept {
            // Store accepted time point and solution
            tran_times.push(step_state.time);
            tran_solutions.push(x.clone());
        }
    }

    RunResult {
        // ...
        tran_times,
        tran_solutions,
    }
}
```

## Usage

### CLI Usage
```bash
# Run TRAN analysis with PSF output
cargo run -p sim-cli -- tests/fixtures/netlists/rc_step.cir -a tran -o /tmp/rc.psf

# With custom precision
cargo run -p sim-cli -- tests/fixtures/netlists/rc_step.cir -a tran -o /tmp/rc.psf --precision 8
```

### API Usage
```rust
use sim_core::analysis::AnalysisPlan;
use sim_core::circuit::AnalysisCmd;
use sim_core::engine::Engine;
use sim_core::result_store::ResultStore;

let circuit = /* parse and build circuit */;
let mut engine = Engine::new_default(circuit);
let mut store = ResultStore::new();

let plan = AnalysisPlan {
    cmd: AnalysisCmd::Tran {
        tstep: 1e-6,
        tstop: 1e-5,
        tstart: 0.0,
        tmax: 1e-5,
    },
};

let run_id = engine.run_with_store(&plan, &mut store);
let run = &store.runs[run_id.0];

// Access waveform data
for (i, time) in run.tran_times.iter().enumerate() {
    let solution = &run.tran_solutions[i];
    println!("t={}: {:?}", time, solution);
}
```

### PSF Output Format
```
PSF_TEXT
# Generated by RustSpice v0.1.0
# Date: 2026-01-29T10:00:00Z

[Transient Analysis]
points = 11
tstart = 0.000000e0
tstop = 1.000000e-5

[Signals]
time
V(0)
V(in)
V(out)

[Data]
        time          V(0)         V(in)        V(out)
  0.000000e0   0.000000e0   1.000000e0   5.000000e-1
  1.000000e-6   0.000000e0   1.000000e0   5.000000e-1
  ...
```

## Test Coverage

Three test cases in `crates/sim-core/tests/tran_waveform_tests.rs`:

1. **tran_waveform_stores_multiple_time_points**
   - Verifies multiple time points are stored
   - Checks time starts at 0
   - Verifies monotonically increasing time

2. **tran_waveform_solution_has_correct_nodes**
   - Verifies solution vectors are non-empty
   - Checks consistent solution size across time points

3. **tran_psf_output_format**
   - Tests PSF file generation
   - Verifies format sections (header, signals, data)

## Memory Considerations

Waveform storage memory usage:
- 10,000 time points × 10 nodes × 8 bytes ≈ 800 KB (acceptable)
- 1,000,000 points would be ~80 MB (may need decimation option for very long simulations)

## Future Enhancements

- [ ] Output decimation: `--tran-points <N>` to limit stored points
- [ ] Signal selection: `--tran-signals V(out),V(in)` to store only selected nodes
- [ ] Binary PSF format for large waveforms
- [ ] Current probes: Store branch currents (I(R1), I(V1))
- [ ] Streaming output for very long simulations

## Files Modified

| File | Changes |
|------|---------|
| `crates/sim-core/src/result_store.rs` | Added `tran_times`, `tran_solutions` fields |
| `crates/sim-core/src/engine.rs` | New `run_tran_result_with_params()` with waveform collection |
| `crates/sim-core/tests/tran_waveform_tests.rs` | Test cases for waveform storage |
| `crates/sim-core/tests/psf_tests.rs` | Updated RunResult constructor |
